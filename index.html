<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Az ember tragédiája - Interaktív Tanulófelület</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --text-color: #212529;
            --header-color: #007bff;
            --button-bg: #28a745;
            --button-hover-bg: #218838;
            --accent-color: #ffc107;
            --accent-hover-color: #e0a800;
            --detail-header-color: #dc3545;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
            --flashcard-front-bg: #e9ecef;
            --flashcard-front-text: #212529;
            --flashcard-back-bg: #343a40;
            --flashcard-back-text: #f8f9fa;
            --highlight-strong: var(--detail-header-color);
            --highlight-em: #6c757d;
            --quote-color: #17a2b8;
            --known-card-border: #28a745;
            --unknown-card-border: #dc3545;
            --quiz-option-bg: #f8f9fa;
            --quiz-option-text: #212529;
            --quiz-option-hover-bg: #e2e6ea;
            --quiz-correct-bg: #d4edda;
            --quiz-correct-text: #155724;
            --quiz-incorrect-bg: #f8d7da;
            --quiz-incorrect-text: #721c24;
            --link-color: #007bff;
        }

        body.dark-mode {
            --primary-bg: #212529;
            --secondary-bg: #343a40;
            --text-color: #f8f9fa;
            --header-color: #58a6ff;
            --button-bg: #379237;
            --button-hover-bg: #2a7a2a;
            --accent-color: #ffca2c;
            --accent-hover-color: #f5bb00;
            --detail-header-color: #f07178;
            --border-color: #495057;
            --shadow-color: rgba(255,255,255,0.05);
            --flashcard-front-bg: #495057;
            --flashcard-front-text: #f8f9fa;
            --flashcard-back-bg: #212529;
            --flashcard-back-text: #f8f9fa;
            --highlight-strong: var(--detail-header-color);
            --highlight-em: #adb5bd;
            --quote-color: #38bdf8;
            --known-card-border: #379237;
            --unknown-card-border: #f07178;
            --quiz-option-bg: #495057;
            --quiz-option-text: #f8f9fa;
            --quiz-option-hover-bg: #5a6268;
            --quiz-correct-bg: #225335;
            --quiz-correct-text: #d1e7dd;
            --quiz-incorrect-bg: #632c3b;
            --quiz-incorrect-text: #f5c6cb;
            --link-color: #58a6ff;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.7; margin: 0; padding: 20px; background-color: var(--primary-bg); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 950px; margin: auto; background: var(--secondary-bg); padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px var(--shadow-color); }
        #menu { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        #menu button, .search-controls button, .flashcard-nav button, #darkModeToggle, .quiz-controls button, .quiz-option button { padding: 10px 18px; cursor: pointer; background-color: var(--button-bg); color: white; border: none; border-radius: 6px; font-size: 1em; transition: background-color 0.2s; }
        #menu button:hover, .search-controls button:hover, .flashcard-nav button:hover, #darkModeToggle:hover, .quiz-controls button:hover, .quiz-option button:hover { background-color: var(--button-hover-bg); }
        .view { margin-top: 25px; animation: fadeInView 0.5s ease-in-out; }
        @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view h2 { text-align: center; color: var(--header-color); margin-bottom: 20px; font-size: 2em; }

        .search-controls, .filter-controls { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; align-items: center; flex-wrap: wrap;}
        .search-controls input[type="text"], .filter-controls select, .quiz-setup select, .quiz-setup input[type="number"] { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--secondary-bg); color: var(--text-color); font-size: 0.95em; }

        #timelineView ul li, #locations button { display: block; width: 95%; max-width: 400px; margin: 10px auto; padding: 14px; background-color: var(--accent-color); color: var(--secondary-bg); border: none; border-radius: 6px; cursor: pointer; font-size: 1.05em; text-align: center; box-sizing: border-box; transition: background-color 0.2s, transform 0.1s; }
        #timelineView ul li:hover, #locations button:hover { background-color: var(--accent-hover-color); transform: translateY(-2px); }
        #timelineView ul { list-style-type: none; padding: 0; }
        .hidden-by-search, .hidden-by-filter { display: none !important; }

        #sceneDetailView { padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--primary-bg); }
        #sceneDetailView h3 { color: var(--detail-header-color); margin-top: 0; font-size: 1.8em; text-align: center; }
        #sceneDetailView .action-buttons { margin-bottom: 20px; display: flex; flex-wrap:wrap; justify-content:center; gap: 10px; }
        #sceneDetailView .action-buttons button { font-size: 0.9em; padding: 8px 15px; }
        #sceneDetailView .back-button { background-color: #6c757d; } #sceneDetailView .back-button:hover { background-color: #5a6268; }
        #sceneDetailView .tts-button { background-color: #17a2b8; } #sceneDetailView .tts-button:hover { background-color: #138496; }
        #sceneDetailView .nav-button { background-color: var(--header-color); } #sceneDetailView .nav-button:hover { background-color: #0056b3; }

        .scene-characters { background-color: var(--secondary-bg); padding: 12px 18px; border-radius: 6px; margin-bottom: 18px; border-left: 5px solid var(--accent-color); box-shadow: 0 2px 4px var(--shadow-color); }
        .scene-characters h5 { margin-top:0; color: var(--header-color); font-size:1.1em; }
        .scene-characters p { margin-bottom: 6px; font-size: 0.95em;}

        details { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px 18px; margin-bottom: 12px; box-shadow: 0 2px 4px var(--shadow-color); }
        summary { font-weight: bold; cursor: pointer; color: var(--header-color); font-size: 1.2em; list-style-type: '▸ '; }
        details[open] summary { list-style-type: '▾ '; }
        summary:hover { color: var(--button-hover-bg); }

        .scene-content-item h4 { display:none; }
        .scene-content-item h5 { color: var(--text-color); margin-top: 18px; margin-bottom: 8px; font-size: 1.2em; }
        .scene-content-item p, .scene-content-item ul { margin-bottom: 12px; } .scene-content-item ul { margin-left: 25px; }
        .scene-content-item strong { color: var(--highlight-strong); font-weight: 600; }
        .scene-content-item em { font-style: italic; color: var(--highlight-em); }
        .scene-content-item .quote { font-style: italic; color: var(--quote-color); margin: 15px 20px; border-left: 4px solid var(--quote-color); padding: 10px 15px; background-color: var(--primary-bg); border-radius:4px;}

        #interactiveMap { height: 450px; width: 100%; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom:20px; }
        .map-info-text { font-style: italic; color: var(--text-color); text-align: center; margin-bottom: 15px; }
        .leaflet-tooltip { background-color: var(--secondary-bg) !important; color: var(--text-color) !important; border: 1px solid var(--header-color) !important; box-shadow: 0 1px 3px var(--shadow-color) !important; border-radius: 4px !important; padding: 6px 10px !important;}
        .leaflet-popup-content-wrapper { background: var(--secondary-bg) !important; color: var(--text-color) !important; border-radius: 6px !important; box-shadow: 0 3px 14px var(--shadow-color) !important;}
        .leaflet-popup-content { margin: 13px 19px !important; font-size: 1em !important; line-height: 1.5 !important;}
        .leaflet-popup-tip { background: var(--secondary-bg) !important; box-shadow: none !important;}

        #flashcardOptions { margin-bottom:15px; display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:15px;}
        #flashcardContainer { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .flashcard { width: 90%; max-width: 550px; min-height: 280px; perspective: 1000px; cursor: pointer; border-radius: 10px; margin-bottom:10px; background-color: transparent; }
        .flashcard.known { box-shadow: 0 0 0 3px var(--known-card-border), 0 4px 8px var(--shadow-color); }
        .flashcard.unknown { box-shadow: 0 0 0 3px var(--unknown-card-border), 0 4px 8px var(--shadow-color); }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.7s; transform-style: preserve-3d; box-shadow: 0 4px 10px var(--shadow-color); border-radius: 10px; }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; box-sizing: border-box; border-radius: 10px; font-size: 1.2em; }
        .flashcard-front { background-color: var(--flashcard-front-bg); color: var(--flashcard-front-text); }
        .flashcard-back { background-color: var(--flashcard-back-bg); color: var(--flashcard-back-text); transform: rotateY(180deg); overflow-y: auto; }
        .flashcard-back h4 { margin-top:0; color: var(--accent-color); font-size:1.1em; }
        .flashcard-back p { margin-bottom: 10px; font-size: 0.9em; text-align:left;}
        .flashcard-actions { margin-top: 10px; display: flex; gap: 10px; justify-content: center;}
        .flashcard-actions button { font-size: 0.9em; padding: 8px 12px; color:white; }
        .flashcard-actions .known-btn { background-color: var(--known-card-border); } .flashcard-actions .known-btn:hover { background-color: #1e7e34;}
        .flashcard-actions .unknown-btn { background-color: var(--unknown-card-border); } .flashcard-actions .unknown-btn:hover { background-color: #b21f2d;}
        .flashcard-nav { display:flex; justify-content:center; align-items:center; gap:15px; margin-top: 10px;}
        .flashcard-nav button { background-color: var(--header-color); font-size: 1em; color:white;}
        .flashcard-nav button:hover { background-color: #0056b3; }
        #cardCounter { font-size: 0.9em; color: var(--text-color); }

        #quizView { text-align: center; }
        .quiz-setup, .quiz-question-area, .quiz-results-area { margin-bottom: 20px; padding: 20px; background-color: var(--secondary-bg); border-radius: 8px; box-shadow: 0 3px 7px var(--shadow-color); }
        .quiz-setup h3, .quiz-question-area h4, .quiz-results-area h3 { color: var(--header-color); margin-top: 0;}
        .quiz-setup label, .quiz-setup select, .quiz-setup input { margin: 8px; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); font-size:1em;}
        .quiz-question-area #questionText { font-size: 1.4em; margin-bottom: 20px; color: var(--text-color); min-height: 40px;}
        .quiz-options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .quiz-option button { width: 100%; background-color: var(--quiz-option-bg); color: var(--quiz-option-text); border: 1px solid var(--border-color); text-align: left; padding: 12px; font-size: 1em; }
        .quiz-option button:hover { background-color: var(--quiz-option-hover-bg); }
        .quiz-option button.correct { background-color: var(--quiz-correct-bg) !important; color: var(--quiz-correct-text) !important; border-color: var(--quiz-correct-text) !important;}
        .quiz-option button.incorrect { background-color: var(--quiz-incorrect-bg) !important; color: var(--quiz-incorrect-text) !important; border-color: var(--quiz-incorrect-text) !important;}
        .quiz-option button.selected { outline: 3px solid var(--accent-color); box-shadow: 0 0 8px var(--accent-color); }
        #feedbackText { margin-top: 18px; font-weight: bold; font-size: 1.1em; min-height: 25px; }
        .quiz-matching-area { display: flex; flex-direction: column; align-items: center; gap:15px; margin-bottom: 15px;}
        .matching-columns-container { display: flex; justify-content: space-around; width:100%;}
        .matching-column { list-style-type: none; padding: 0; width: 48%; }
        .matching-column li { background-color: var(--quiz-option-bg); color: var(--quiz-option-text); border: 1px solid var(--border-color); padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .matching-column li:hover { background-color: var(--quiz-option-hover-bg); }
        .matching-column li.selected-match-item-a, .matching-column li.selected-match-item-b { background-color: var(--accent-color); color: white; }
        .matching-column li.correct-match { border-left: 5px solid var(--quiz-correct-bg); }
        .matching-column li.incorrect-match { border-left: 5px solid var(--quiz-incorrect-bg); }
        #matchSubmitButton { margin-top: 10px; }
        #quizProgress, #quizScore { margin-top:12px; font-size: 1.1em; color: var(--text-color);}
        #quizResultsArea p {font-size: 1.2em; margin: 10px 0;}

        #darkModeToggleContainer { text-align: right; margin-bottom: 10px; }
        #darkModeToggle { background-color: #6c757d; font-size: 0.9em; color:white; }
        #darkModeToggle:hover { background-color: #545b62; }
        audio { margin-top: 15px; width: 100%; }

    </style>
</head>
<body>
    <div class="container">
        <div id="darkModeToggleContainer">
            <button id="darkModeToggle" onclick="toggleDarkMode()">🌙 Sötét Mód</button>
        </div>
        <header style="text-align:center; margin-bottom:20px;">
            <h1>Az ember tragédiája - Interaktív Tanulófelület</h1>
            <p>Madách Imre műve</p>
        </header>

        <div id="menu">
            <button onclick="showView('mapView')">🗺️ Térkép Nézet</button>
            <button onclick="showView('timelineView')">⏳ Idővonal Nézet</button>
            <button onclick="showView('flashcardView')">🎴 Tanulókártyák</button>
            <button onclick="showView('quizView')">❓ Kvíz</button>
        </div>

        <div id="mapView" class="view">
            <h2>Térkép Nézet</h2>
            <p class="map-info-text">Kattints egy jelölőre a térképen a helyszín részleteiért! Nem minden színnek van konkrét térképes jelölője.</p>
            <div id="interactiveMap"></div>
            <div id="locations" style="text-align:center;"></div>
        </div>

        <div id="timelineView" class="view" style="display:none;">
            <h2>Idővonal Nézet</h2>
            <div class="search-controls">
                <input type="text" id="timelineSearchInput" onkeyup="filterTimeline()" placeholder="Keresés a színekben...">
            </div>
            <ul id="timelineList"></ul>
        </div>

        <div id="sceneDetailView" style="display:none;">
            <div class="action-buttons">
                <button class="back-button" onclick="goBack()">↩️ Vissza</button>
                <button class="tts-button" onclick="speakSceneContent()">🔊 Felolvasás (Backend)</button>
                <button class="nav-button" id="prevSceneButton" onclick="navigateToScene(-1)">❮ Előző Szín</button>
                <button class="nav-button" id="nextSceneButton" onclick="navigateToScene(1)">Következő Szín ❯</button>
            </div>
            <h3 id="sceneTitleDetail"></h3>
            <div id="sceneContentDetail"></div>
            <audio id="audioPlayer" controls></audio>
        </div>


        <div id="flashcardView" class="view" style="display:none;">
            <h2>Tanulókártyák</h2>
            <div class="search-controls">
                <input type="text" id="flashcardSearchInput" onkeyup="filterFlashcards()" placeholder="Keresés a kártyacímekben...">
            </div>
            <div id="flashcardOptions" class="filter-controls">
                <label for="shuffleFlashcards">Keverés:</label>
                <input type="checkbox" id="shuffleFlashcards" onchange="toggleShuffleAndReloadFlashcards()">
                <label for="filterKnownFlashcards" style="margin-left: 15px;">Szűrés:</label>
                <select id="filterKnownFlashcards" onchange="filterFlashcardsByKnownStatus()">
                    <option value="all">Összes kártya</option>
                    <option value="unknown">Csak a "Még nem" tudottak</option>
                    <option value="known">Csak a "Tudom" jelöltek</option>
                </select>
            </div>
            <div id="flashcardContainer">
                <div class="flashcard" onclick="flipCurrentCard()">
                    <div class="flashcard-inner">
                        <div class="flashcard-front"><p id="flashcardQuestion"></p></div>
                        <div class="flashcard-back"><div id="flashcardAnswer"></div></div>
                    </div>
                </div>
                <div class="flashcard-actions">
                    <button class="unknown-btn" onclick="markFlashcard(false)">❌ Még nem</button>
                    <button class="known-btn" onclick="markFlashcard(true)">✅ Tudom</button>
                </div>
                <div class="flashcard-nav">
                    <button onclick="prevFlashcard()">❮ Előző</button>
                    <span id="cardCounter">1 / X</span>
                    <button onclick="nextFlashcard()">Következő ❯</button>
                </div>
            </div>
            <p id="noFlashcardsFound" style="text-align:center; display:none; margin-top:20px;">Nincsenek a keresésnek/szűrésnek megfelelő kártyák.</p>
        </div>

        <div id="quizView" class="view" style="display:none;">
            <h2>Kvíz</h2>
            <div class="quiz-setup" id="quizSetupArea">
                <h3>Kvíz Beállítások</h3>
                <div>
                    <label for="quizNumQuestions">Kérdések száma:</label>
                    <select id="quizNumQuestions">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="all">Összes generált</option>
                    </select>
                </div>
                <div>
                    <label for="quizQuestionType">Kérdés típusok:</label>
                    <select id="quizQuestionType">
                        <option value="all" selected>Vegyes</option>
                        <option value="mcq_roles">Szereplők (MCQ)</option>
                        <option value="mcq_ideas">Fő eszmék (MCQ)</option>
                        <option value="match_scene_role">Szín-Szerep Párosítás</option>
                        <option value="match_scene_idea">Szín-Eszme Párosítás</option>
                    </select>
                </div>
                <button onclick="startQuiz()" style="margin-top:15px; background-color:var(--accent-color);">Kvíz Indítása</button>
            </div>

            <div class="quiz-question-area" id="quizQuestionArea" style="display:none;">
                <div id="quizProgress"></div>
                <div id="quizScore" style="margin-bottom:10px;"></div>
                <h4 id="questionText">Kérdés szövege itt...</h4>
                <div id="mcqOptions" class="quiz-options-grid"></div>
                <div id="matchingOptions" class="quiz-matching-area">
                    <div class="matching-columns-container">
                        <ul class="matching-column" id="matchingColumnA"></ul>
                        <ul class="matching-column" id="matchingColumnB"></ul>
                    </div>
                    <button onclick="submitMatchAnswer()" id="matchSubmitButton" class="quiz-controls" style="display:none; margin-top:10px;">Párosítás Ellenőrzése</button>
                </div>
                <p id="feedbackText"></p>
                <button onclick="nextQuizQuestion()" id="nextQuestionButton" class="quiz-controls" style="display:none; margin-top:10px;">Következő Kérdés</button>
            </div>

            <div class="quiz-results-area" id="quizResultsArea" style="display:none;">
                <h3>Kvíz Eredménye</h3>
                <p id="finalScoreText">Pontszámod: X / Y</p>
                <p id="finalPercentageText">Százalék: Z%</p>
                <button onclick="restartQuizSetup()" class="quiz-controls">Új Kvíz</button>
            </div>
        </div>

        <div id="sceneStore" style="display:none;">
            <div id="content-menny" class="scene-content-item" data-scene-key="menny" data-adam-role="N/A (Még nem jelenik meg)" data-eva-role="N/A (Még nem jelenik meg)" data-lucifer-role="Kritikus, Tagadó Szellem" data-main-idea="A teremtés tökéletessége vs. a tagadás és a kritika joga." data-location-name="A Menny" data-period="Kezdetek">
                <h4>1. Szín: A Mennyben</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Az Úr:</strong> A teremtő.</p><p><strong>Angyalok kara:</strong> Gábor (Eszme), Mihály (Erő), Rafael (Jóság).</p><p><strong>Lucifer:</strong> A tagadás szelleme.</p></div>
                <details open><summary>Központi eszme</summary><p>A teremtés tökéletessége vs. a tagadás és a kritika joga. Az isteni világrend és a disszonancia megjelenése.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Az angyalok dicsőítik a teremtést. Lucifer kritikával illeti azt. Az Úr neki adja a tudás és ítélet fáját.</p></details>
                <details><summary>Jelentőség</summary><p>Megalapozza a drámai küzdelmet; Lucifer elhatározza az ember megkísértését.</p></details>
            </div>

            <div id="content-paradicsom" class="scene-content-item" data-scene-key="paradicsom" data-adam-role="Az első ember (ártatlan)" data-eva-role="Az első nő (ártatlan)" data-lucifer-role="Kísértő" data-main-idea="Ártatlanság, tudatlanság boldogsága vs. tudásvágy; bűnbeesés." data-location-name="Paradicsom" data-period="Kezdetek">
                <h4>2. Szín: A Paradicsomban</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Az első ember.</p><p><strong>Éva:</strong> Az első nő.</p><p><strong>Lucifer:</strong> Kísértő.</p></div>
                <details open><summary>Központi eszme</summary><p>Az ártatlanság, a tudatlanság boldogsága vs. a tudásvágy, a fejlődés iránti ösztön. A bűnbeesés lehetősége.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Gondtalan élet. Lucifer a tudás ígéretével kísért. Esznek a tiltott gyümölcsből.</p></details>
                <details><summary>Ádám és Éva felismerése/állapota</summary><p>Elveszítik ártatlanságukat, megismerik a jót-rosszat, szégyent, félelmet, halandóságot. Kiűzetnek.</p></details>
            </div>

            <div id="content-paradicsomonkivul_elom" class="scene-content-item" data-scene-key="paradicsomonkivul_elom" data-adam-role="Földön küzdő ember" data-eva-role="Ádám társa a száműzetésben" data-lucifer-role="Álom felajánlója" data-main-idea="Földi lét nehézségei, munka. Vágy a jövő megismerésére." data-location-name="Paradicsomon kívül" data-period="Kezdetek">
                <h4>3. Szín: A Paradicsomon kívül (Álom előtt)</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Földi küzdelmek.</p><p><strong>Éva:</strong> Társa.</p><p><strong>Lucifer:</strong> Álmot ajánl.</p></div>
                <details open><summary>Központi eszme</summary><p>A földi lét nehézségei, a munka, a küzdelem. Az ember vágya a tudásra, a jövő megismerésére.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Mostoha világ. Ádám a küzdelem értelmét keresi. Lucifer álmot bocsát rá a jövőről.</p></details>
                <details><summary>Ádám és Éva állapota</summary><p>Elalszanak. Ádám álomutazása kezdődik, Éva jelképesen alszik a 15. színig.</p></details>
            </div>

            <div id="content-egyiptom" class="scene-content-item" data-scene-key="egyiptom" data-adam-role="Ifjú fáraó" data-eva-role="Rabszolganő felesége" data-lucifer-role="Ádám minisztere" data-main-idea="Egyéni dicsőség, hatalom, halhatatlanság ('Milliók egy miatt')." data-location-name="Egyiptom" data-period="Ókor">
                <h4>4. Szín: Egyiptom</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Ifjú fáraó.</p><p><strong>Éva:</strong> Rabszolganő felesége.</p><p><strong>Lucifer:</strong> Ádám minisztere.</p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>Az egyéni dicsőség, hatalom, halhatatlanság vágya. <em>"Milliók egy miatt."</em></p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>Piramisépítés. Egy rabszolganő (Éva) átka és a szenvedés rádöbbenti Ádámot a dicsőség árára.</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Kiábrándulás az egyéni dicsőségből. Vágy az egyenlőségre, a nép szabadságára. <em>"Egy millióért!"</em></p></details>
            </div>

            <div id="content-athen" class="scene-content-item" data-scene-key="athen" data-adam-role="Miltiádész (hadvezér)" data-eva-role="Lucia (Miltiádész felesége)" data-lucifer-role="Demagóg" data-main-idea="Demokrácia, szabadság, népuralom." data-location-name="Athén" data-period="Ókor">
                <h4>5. Szín: Athén</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Miltiádész.</p><p><strong>Éva:</strong> Lucia.</p><p><strong>Lucifer:</strong> Demagóg.</p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>Demokrácia, szabadság, népuralom.</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>A nép Miltiádész ellen fordul. Árulással vádolják és halálra ítélik.</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Csalódás a népben és a demokráciában. Hedonizmus felé fordul: <em>"Örülj, mulass..."</em></p></details>
            </div>

            <div id="content-roma" class="scene-content-item" data-scene-key="roma" data-adam-role="Sergiolus (gazdag arisztokrata)" data-eva-role="Júlia (léha nő)" data-lucifer-role="Miló (mulatótárs)" data-main-idea="Hedonizmus, gyönyörök hajszolása (carpe diem)." data-location-name="Róma" data-period="Ókor">
                <h4>6. Szín: Róma</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Sergiolus.</p><p><strong>Éva:</strong> Júlia.</p><p><strong>Lucifer:</strong> Miló.</p><p><strong>Péter apostol.</strong></p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>Hedonizmus, gyönyörök hajszolása (carpe diem).</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>Orgiák, pestis. Az élvezetek kiüresedése. Hippia halála.</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Kiábrándulás. Péter apostol hatására a keresztény testvériség, szeretet felé fordul.</p></details>
            </div>

            <div id="content-konstantinapoly" class="scene-content-item" data-scene-key="konstantinapoly" data-adam-role="Tankréd (keresztes lovag)" data-eva-role="Izóra (apáca)" data-lucifer-role="Fegyverhordozó" data-main-idea="Keresztény hit, testvériség (eltorzult formában)." data-location-name="Konstantinápoly (Bizánc)" data-period="Középkor">
                <h4>7. Szín: Konstantinápoly (Bizánc)</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Tankréd.</p><p><strong>Éva:</strong> Izóra.</p><p><strong>Lucifer:</strong> Fegyverhordozó.</p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>Keresztény hit, testvériség, szeretet.</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>A kereszténység eltorzulása: dogmatizmus, vallási türelmetlenség, eretneküldözés.</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Csalódás. A tudomány felé fordul.</p></details>
            </div>

            <div id="content-praga1" class="scene-content-item" data-scene-key="praga1" data-adam-role="Johannes Kepler (csillagász)" data-eva-role="Borbála (Kepler felesége)" data-lucifer-role="Famulus (Kepler segédje)" data-main-idea="Tudomány, megismerés, a világ megértése." data-location-name="Prága" data-period="Újkor (Reneszánsz)">
                <h4>8. Szín: Prága I.</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Kepler.</p><p><strong>Éva:</strong> Borbála.</p><p><strong>Lucifer:</strong> Famulus.</p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>Tudomány, megismerés, a világ megértésének vágya.</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>A tudós anyagi gondjai, kiszolgáltatottsága. Felesége kicsapongó, értetlen.</p></details>
                <details><summary>Ádám állapota/Új cél</summary><p>Csalódás a tudós létben. Álomba menekül, a forradalom eszméi felé.</p></details>
            </div>

            <div id="content-parizs" class="scene-content-item" data-scene-key="parizs" data-adam-role="Danton (forradalmár)" data-eva-role="Két alakban: Arisztokrata márkinő / Vérszomjas forradalmárnő" data-lucifer-role="Hóhér" data-main-idea="'Egyenlőség, testvériség, szabadság!' (Francia forradalom)." data-location-name="Párizs" data-period="Újkor (Forradalmak kora)">
                <h4>9. Szín: Párizs ("Álom az álomban")</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Danton.</p><p><strong>Éva:</strong> Márkinő/Forradalmárnő.</p><p><strong>Lucifer:</strong> Hóhér.</p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p><em>"Egyenlőség, testvériség, szabadság!"</em> – a francia forradalom jelszavai.</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>Forradalmi hév, majd terror, erőszak, kivégzések. A forradalom felfalja gyermekeit.</p></details>
                <details><summary>Ádám felismerése/állapota</summary><p>Kiábrándulás az eszmék véres megvalósulásából. Felébred.</p></details>
            </div>

             <div id="content-praga2" class="scene-content-item" data-scene-key="praga2" data-adam-role="Johannes Kepler (felébredve)" data-eva-role="Borbála (felesége)" data-lucifer-role="Famulus" data-main-idea="Tudomány és forradalmi eszmék újraértékelése." data-location-name="Prága" data-period="Újkor (Reneszánsz)">
                <h4>10. Szín: Prága II.</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Kepler.</p><p><strong>Éva:</strong> Borbála.</p><p><strong>Lucifer:</strong> Famulus.</p><p><strong>Tanítvány.</strong></p></div>
                <details open><summary>Központi eszme</summary><p>A tudomány és a forradalmi eszmék újraértékelése a párizsi álom után.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Kepler felébred. Párizsi álom hatása. Kiábrándult a tanítvány naiv lelkesedésétől. Éva is visszatér.</p></details>
                <details><summary>Ádám állapota/Új cél</summary><p>Óvatos remény, de kiábrándultság. Lucifer új álmot ígér: London.</p></details>
            </div>

            <div id="content-london" class="scene-content-item" data-scene-key="london" data-adam-role="Idősödő, kiábrándult polgár" data-eva-role="Több alakban (Dáma / Virágárus / Prostituált)" data-lucifer-role="Cinikus kísérő" data-main-idea="'Szabad verseny' kapitalizmusa, ipari fejlődés." data-location-name="London" data-period="Újkor (Ipari forradalom)">
                 <h4>11. Szín: London</h4>
                 <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Idősödő polgár.</p><p><strong>Éva:</strong> Dáma/Virágárus.</p><p><strong>Lucifer:</strong> Kísérő.</p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>A "szabad verseny" kapitalizmusa, ipari fejlődés, haladás.</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>Nyüzsgő vásár, <em>"minden eladó"</em>. Gazdagság vs. nyomor. Elidegenedés, pénz hatalma. Éva sorsa.</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Kiábrándulás. Undor a pénz hatalmától. Vágy egy racionális társadalomra (Falanszter).</p></details>
            </div>

            <div id="content-falanszter" class="scene-content-item" data-scene-key="falanszter" data-adam-role="Kritikus szemlélő" data-eva-role="Munkáslány (Ádámhoz rendelve)" data-lucifer-role="Cinikus kommentátor" data-main-idea="Tudomány mindenhatósága, totális racionalitás, közjó, hasznosság." data-location-name="Falanszter (Jövő)" data-period="Jövő (Utópia/Disztópia)">
                <h4>12. Szín: A Falanszter</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Szemlélő.</p><p><strong>Éva:</strong> Munkáslány.</p><p><strong>Lucifer:</strong> Kommentátor.</p><p><strong>Tudós.</strong></p><p><strong>"Bűnösök", Plátó, Michelangelo.</strong></p></div>
                <details open><summary>Központi eszme (Tézis)</summary><p>Tudomány mindenhatósága, totális racionalitás, közjó és hasznosság elve. Az individualitás, érzelmek, művészetek kiiktatása.</p></details>
                <details><summary>Cselekmény és konfliktus (Antitézis)</summary><p>Tökéletesen szabályozott, de lélektelen világ. Egyéniség elnyomása. Művészet leértékelése. "Haszontalan" egyének kegyetlen büntetése/kiiktatása. Zsenik preventív "elnyomása".</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Undor a hideg racionalitásból. Vágy a tiszta szellem világába (Űr).</p></details>
            </div>

            <div id="content-ur" class="scene-content-item" data-scene-key="ur" data-adam-role="Az Abszolútumot kereső" data-eva-role="N/A (A Föld Szelleme szól)" data-lucifer-role="Szkeptikus kísérő" data-main-idea="Vágy a transzcendenciára, tiszta szellemiségre. Elszakadás az anyagtól." data-location-name="Az Űr" data-period="Jövő (Kozmikus út)">
                <h4>13. Szín: Az Űrben</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Kereső.</p><p><strong>Lucifer:</strong> Kísérő.</p><p><strong>Föld Szellemének hangja.</strong></p></div>
                <details open><summary>Központi eszme</summary><p>Vágy a transzcendenciára, a tiszta szellemiségre. Az anyagtól való elszakadás és annak veszélyei.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Elszakadás a Földtől. Kezdeti felszabadultság, majd hidegség, magány, semmi. A Föld Szelleme visszahívja.</p></details>
                <details><summary>Ádám felismerése/Új cél</summary><p>Sorsa a Földhöz kötött. Visszavágyik a földi küzdelmekhez. A fejlődés utolsó lehetőségét keresi.</p></details>
            </div>

            <div id="content-eszkimo" class="scene-content-item" data-scene-key="eszkimo" data-adam-role="Idős, haldokló ember" data-eva-role="Eszkimó nő (fajfenntartás utolsó reménye)" data-lucifer-role="Cinikus szemlélő" data-main-idea="Emberiség teljes leépülése. Puszta létfenntartás. Darwini determinizmus." data-location-name="Eszkimók földje (Jövő vége)" data-period="Jövő (Végkifejlet)">
                <h4>14. Szín: Az eszkimók földjén</h4>
                <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Haldokló.</p><p><strong>Éva:</strong> Eszkimó nő.</p><p><strong>Lucifer:</strong> Szemlélő.</p><p><strong>Eszkimó férfi.</strong></p></div>
                <details open><summary>Központi eszme</summary><p>Az emberiség teljes fizikai és szellemi leépülése. Puszta létfenntartás, ideálok elvesztése. Darwini determinizmus.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Haldokló Föld, jég borítja. Emberiség maradéka ösztönlényként küzd. Erkölcs, tudomány, művészet eltűnt.</p></details>
                <details><summary>Ádám állapota</summary><p>Végső kiábrándulás. Minden küzdelem hiábavalónak tűnik. Ezzel ébred fel.</p></details>
            </div>

            <div id="content-paradicsomonkivul_utan" class="scene-content-item" data-scene-key="paradicsomonkivul_utan" data-adam-role="Felébredt, kétségbeesett ember" data-eva-role="Reményt hozó anya" data-lucifer-role="Utolsó kísértő" data-main-idea="Lét értelmének végső kérdése. Szabad akarat vs. determinizmus. Küzdelem és hit." data-location-name="Paradicsomon kívül" data-period="Jelen (Lezárás)">
                <h4>15. Szín: A Paradicsomon kívül (Álom után)</h4>
                 <div class="scene-characters"><h5>Főbb szereplők:</h5><p><strong>Ádám:</strong> Kétségbeesett.</p><p><strong>Éva:</strong> Reményt hoz.</p><p><strong>Lucifer:</strong> Kísértő.</p><p><strong>Az Úr hangja.</strong></p></div>
                <details open><summary>Központi eszme</summary><p>Az emberi lét értelmének végső kérdése. Szabad akarat vs. determinizmus. Küzdelem és hit szükségessége.</p></details>
                <details><summary>Cselekmény és konfliktus</summary><p>Ádám öngyilkosságra készül. Lucifer érvel ellene. Éva bejelenti várandósságát. Ádám kérdései az Úrhoz.</p>
                <p class="quote"><strong>Ádám kérdése:</strong> "...mi végre termek én? Végződik-e a földi pálya hát Nagy cél felé...?"</p></details>
                <details><summary>Az Úr válasza és a mű befejezése</summary><p>Az Úr nem ad konkrét válaszokat, de a küzdelemre és hitre szólít fel.</p>
                <p class="quote"><strong>Az Úr szava:</strong> "Mondottam, ember: küzdj és bízva bízzál!"</p></details>
            </div>
        </div>
    </div>

    <script>
        let currentView = 'mapView';
        let map;
        let mapInitialized = false;
        let currentDetailSceneKey = null;
        const sceneOrder = [
            'menny', 'paradicsom', 'paradicsomonkivul_elom', 'egyiptom', 'athen', 'roma',
            'konstantinapoly', 'praga1', 'parizs', 'praga2', 'london', 'falanszter',
            'ur', 'eszkimo', 'paradicsomonkivul_utan'
        ];

        const sceneData = {};

        const sceneLocations = [
            { key: 'paradicsom', name: 'Paradicsom (2. szín)', coords: [31.7683, 35.2137], zoom: 7 },
            { key: 'paradicsomonkivul_elom', name: 'Paradicsomon kívül (3. & 15. szín)', coords: [31.5, 35.0], zoom: 7 },
            { key: 'egyiptom', name: 'Egyiptom (4. szín)', coords: [26.8206, 30.8025], zoom: 5 },
            { key: 'athen', name: 'Athén (5. szín)', coords: [37.9838, 23.7275], zoom: 6 },
            { key: 'roma', name: 'Róma (6. szín)', coords: [41.9028, 12.4964], zoom: 6 },
            { key: 'konstantinapoly', name: 'Konstantinápoly (7. szín)', coords: [41.0082, 28.9784], zoom: 6 },
            { key: 'praga1', name: 'Prága (8. & 10. szín)', coords: [50.0755, 14.4378], zoom: 6 },
            { key: 'parizs', name: 'Párizs (9. szín)', coords: [48.8566, 2.3522], zoom: 6 },
            { key: 'london', name: 'London (11. szín)', coords: [51.5074, 0.1278], zoom: 6 },
            { key: 'falanszter', name: 'Falanszter (12. szín)', coords: [47.0, 19.0], zoom: 4, note: "Helyszín szimbolikus" },
            { key: 'eszkimo', name: 'Eszkimók földje (14. szín)', coords: [75.0, -100.0], zoom: 3 }
        ];

        function getSceneDataFromDOM() {
            const sceneElements = document.querySelectorAll('#sceneStore .scene-content-item');
            sceneElements.forEach(el => {
                const key = el.dataset.sceneKey;
                if (key) {
                    sceneData[key] = {
                        title: el.querySelector('h4')?.innerText || "Ismeretlen Szín",
                        adamRole: el.dataset.adamRole || "N/A",
                        evaRole: el.dataset.evaRole || "N/A",
                        luciferRole: el.dataset.luciferRole || "N/A",
                        mainIdea: el.dataset.mainIdea || "N/A",
                        locationName: el.dataset.locationName || "N/A",
                        period: el.dataset.period || "N/A",
                        fullContentElement: el
                    };
                }
            });
        }


        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const button = document.getElementById('darkModeToggle');
            const isDarkMode = document.body.classList.contains('dark-mode');
            button.textContent = isDarkMode ? '☀️ Világos Mód' : '🌙 Sötét Mód';
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            if (map && mapInitialized) {
                setTimeout(() => { map.invalidateSize() }, 50);
            }
        }
        function applyInitialDarkMode() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '☀️ Világos Mód';
            }
        }

        function initializeMap() {
            if (!mapInitialized && document.getElementById('interactiveMap')) {
                map = L.map('interactiveMap').setView([48.0, 15.0], 4);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd', maxZoom: 19
                }).addTo(map);

                const locationsContainer = document.getElementById('locations');
                locationsContainer.innerHTML = '';

                sceneLocations.forEach(location => {
                    const marker = L.marker(location.coords).addTo(map);
                    let tooltipText = sceneData[location.key]?.title || location.name;
                    if (location.note) tooltipText += ` (${location.note})`;
                    marker.bindTooltip(tooltipText);
                    marker.on('click', () => { showSceneDetails(location.key); });
                });

                sceneOrder.forEach(key => {
                    if (!sceneLocations.some(loc => loc.key === key) && sceneData[key]) {
                        const button = document.createElement('button');
                        button.textContent = sceneData[key].title + " (Nincs térképjelölő)";
                        button.onclick = () => showSceneDetails(key);
                        locationsContainer.appendChild(button);
                    }
                });
                mapInitialized = true;
                setTimeout(() => { map.invalidateSize() }, 50);
            } else if (map) {
                setTimeout(() => { map.invalidateSize() }, 50);
            }
        }

        function populateTimeline() {
            const timelineList = document.getElementById('timelineList');
            if (!timelineList) return;
            timelineList.innerHTML = '';
            sceneOrder.forEach(key => {
                if (sceneData[key]) {
                    const li = document.createElement('li');
                    li.textContent = sceneData[key].title;
                    li.onclick = () => showSceneDetails(key);
                    li.dataset.sceneKey = key;
                    timelineList.appendChild(li);
                }
            });
        }

        function filterTimeline() {
            const input = document.getElementById('timelineSearchInput');
            const filter = input.value.toLowerCase();
            const ul = document.getElementById('timelineList');
            if (!ul) return;
            const liItems = ul.getElementsByTagName('li');

            for (let i = 0; i < liItems.length; i++) {
                const txtValue = liItems[i].textContent || liItems[i].innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    liItems[i].classList.remove('hidden-by-search');
                } else {
                    liItems[i].classList.add('hidden-by-search');
                }
            }
        }

        function showView(viewId) {
            ['mapView', 'timelineView', 'sceneDetailView', 'flashcardView', 'quizView'].forEach(id => {
                const view = document.getElementById(id);
                if (view) view.style.display = 'none';
            });

            const selectedView = document.getElementById(viewId);
            if (selectedView) selectedView.style.display = 'block';
            currentView = viewId;

            if (viewId === 'mapView') {
                initializeMap();
            } else if (viewId === 'timelineView') {
                populateTimeline();
            } else if (viewId === 'flashcardView') {
                if (flashcards.length === 0) prepareFlashcards();
                loadFlashcards();
            } else if (viewId === 'quizView') {
                document.getElementById('quizSetupArea').style.display = 'block';
                document.getElementById('quizQuestionArea').style.display = 'none';
                document.getElementById('quizResultsArea').style.display = 'none';
            }
        }

        function showSceneDetails(sceneKey) {
            currentDetailSceneKey = sceneKey;
            const sceneContentElement = document.getElementById('content-' + sceneKey);
            const sceneTitle = sceneData[sceneKey]?.title || "Ismeretlen Szín";

            document.getElementById('sceneTitleDetail').innerText = sceneTitle;
            if (!sceneContentElement) {
                document.getElementById('sceneContentDetail').innerHTML = "<p>A tartalom nem található.</p>";
            } else {
                const clonedContent = sceneContentElement.cloneNode(true);
                clonedContent.querySelector('h4').style.display = 'none';
                document.getElementById('sceneContentDetail').innerHTML = '';
                document.getElementById('sceneContentDetail').appendChild(clonedContent);
            }

            const currentIndex = sceneOrder.indexOf(sceneKey);
            document.getElementById('prevSceneButton').style.display = (currentIndex > 0) ? 'inline-block' : 'none';
            document.getElementById('nextSceneButton').style.display = (currentIndex < sceneOrder.length - 1) ? 'inline-block' : 'none';

            showView('sceneDetailView');
            window.scrollTo(0, 0);
        }

        function navigateToScene(direction) {
            const currentIndex = sceneOrder.indexOf(currentDetailSceneKey);
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < sceneOrder.length) {
                showSceneDetails(sceneOrder[newIndex]);
            }
        }

        function goBack() {
            document.getElementById('sceneDetailView').style.display = 'none';
            let returnView = 'timelineView';
            if (currentViewBeforeDetail && currentViewBeforeDetail !== 'sceneDetailView') {
                returnView = currentViewBeforeDetail;
            }
            showView(returnView);

            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = '';
            audioPlayer.pause();
        }
        let currentViewBeforeDetail = 'timelineView';
        function showView(viewId) {
            if (currentView !== 'sceneDetailView' && viewId !== 'sceneDetailView') {
                currentViewBeforeDetail = currentView;
            }
            ['mapView', 'timelineView', 'sceneDetailView', 'flashcardView', 'quizView'].forEach(id => {
                const view = document.getElementById(id);
                if (view) view.style.display = 'none';
            });

            const selectedView = document.getElementById(viewId);
            if (selectedView) selectedView.style.display = 'block';
            currentView = viewId;

            if (viewId === 'mapView') {
                initializeMap();
            } else if (viewId === 'timelineView') {
                populateTimeline();
            } else if (viewId === 'flashcardView') {
                if (flashcards.length === 0) prepareFlashcards();
                loadFlashcards();
            } else if (viewId === 'quizView') {
                if (!quizInitialized) prepareQuizData();
                document.getElementById('quizSetupArea').style.display = 'block';
                document.getElementById('quizQuestionArea').style.display = 'none';
                document.getElementById('quizResultsArea').style.display = 'none';
            }
        }


        let flashcards = [];
        let originalFlashcards = [];
        let currentFlashcardIndex = 0;
        let shuffleActive = false;
        let knownStatusFilter = 'all';
        let filteredFlashcards = [];

        function prepareFlashcards() {
            originalFlashcards = sceneOrder.map(key => {
                const scene = sceneData[key];
                const sceneContentEl = document.getElementById('content-' + key);
                let answerHTML = `<h4>${scene.title}</h4>`;
                if (sceneContentEl) {
                    const charactersP = sceneContentEl.querySelector('.scene-characters p');
                    const characters = charactersP ? charactersP.innerText.split(':')[1]?.trim() : scene.characters || "N/A";
                    const eszmeP = sceneContentEl.querySelector('details[open] > summary:nth-of-type(1) + p');
                    const eszmeText = eszmeP ? eszmeP.innerText : scene.mainIdea;

                    answerHTML += `<p><strong>Főbb Szereplő (pl.):</strong> ${characters.split(',')[0].substring(0,100)}</p>`;
                    answerHTML += `<p><strong>Központi Eszme:</strong> ${eszmeText.substring(0, 200)}...</p>`;
                }

                return {
                    id: key,
                    question: `Mi a(z) "${scene.title}" szín főbb jellemzője/kulcsgondolata?`,
                    answer: answerHTML,
                    titleForSearch: scene.title.toLowerCase(),
                    isKnown: false
                };
            }).filter(card => card.question && card.answer);
            flashcards = [...originalFlashcards];
            applyAllFlashcardFilters();
        }

        function displayFlashcard() {
            const flashcardElement = document.querySelector('.flashcard');
            const questionEl = document.getElementById('flashcardQuestion');
            const answerEl = document.getElementById('flashcardAnswer');
            const counterEl = document.getElementById('cardCounter');
            const noCardsEl = document.getElementById('noFlashcardsFound');
            const navButtons = document.querySelector('.flashcard-nav');
            const actionButtons = document.querySelector('.flashcard-actions');


            if (filteredFlashcards.length === 0) {
                questionEl.textContent = "Nincs megjeleníthető kártya.";
                answerEl.innerHTML = "";
                counterEl.textContent = "0 / 0";
                if (flashcardElement) flashcardElement.style.display = 'none';
                if (navButtons) navButtons.style.display = 'none';
                if (actionButtons) actionButtons.style.display = 'none';
                if (noCardsEl) noCardsEl.style.display = 'block';
                return;
            }

            if (flashcardElement) flashcardElement.style.display = 'block';
            if (navButtons) navButtons.style.display = 'flex';
            if (actionButtons) actionButtons.style.display = 'flex';
            if (noCardsEl) noCardsEl.style.display = 'none';


            const card = filteredFlashcards[currentFlashcardIndex];
            questionEl.textContent = card.question;
            answerEl.innerHTML = card.answer;
            counterEl.textContent = `${currentFlashcardIndex + 1} / ${filteredFlashcards.length}`;

            flashcardElement.classList.remove('is-flipped', 'known', 'unknown');
            if (card.isKnown) {
                flashcardElement.classList.add('known');
            } else {
                flashcardElement.classList.add('unknown');
            }
        }

        function flipCurrentCard() {
            if (filteredFlashcards.length > 0) {
                document.querySelector('.flashcard').classList.toggle('is-flipped');
            }
        }

        function nextFlashcard() {
            if (filteredFlashcards.length > 0) {
                currentFlashcardIndex = (currentFlashcardIndex + 1) % filteredFlashcards.length;
                displayFlashcard();
            }
        }

        function prevFlashcard() {
            if (filteredFlashcards.length > 0) {
                currentFlashcardIndex = (currentFlashcardIndex - 1 + filteredFlashcards.length) % filteredFlashcards.length;
                displayFlashcard();
            }
        }

        function markFlashcard(known) {
            if (filteredFlashcards.length > 0) {
                const cardInOriginalArray = originalFlashcards.find(c => c.id === filteredFlashcards[currentFlashcardIndex].id);
                if (cardInOriginalArray) cardInOriginalArray.isKnown = known;
                filteredFlashcards[currentFlashcardIndex].isKnown = known;
                displayFlashcard();
                if (knownStatusFilter !== 'all') {
                    setTimeout(() => {
                        applyAllFlashcardFilters();
                        if(currentFlashcardIndex >= filteredFlashcards.length && filteredFlashcards.length > 0) {
                            currentFlashcardIndex = filteredFlashcards.length -1;
                        }
                        displayFlashcard();
                    }, 300);
                }
            }
        }

        function toggleShuffleAndReloadFlashcards() {
            shuffleActive = document.getElementById('shuffleFlashcards').checked;
            loadFlashcards();
        }

        function filterFlashcardsByKnownStatus() {
            knownStatusFilter = document.getElementById('filterKnownFlashcards').value;
            applyAllFlashcardFilters();
        }

        function filterFlashcards() {
            applyAllFlashcardFilters();
        }

        function applyAllFlashcardFilters() {
            const searchInput = document.getElementById('flashcardSearchInput');
            const filterText = searchInput ? searchInput.value.toLowerCase() : "";

            let tempFiltered = shuffleActive ? [...flashcards].sort(() => Math.random() - 0.5) : [...flashcards];

            if (filterText) {
                tempFiltered = tempFiltered.filter(card => card.titleForSearch.includes(filterText));
            }

            if (knownStatusFilter === 'known') {
                tempFiltered = tempFiltered.filter(card => card.isKnown);
            } else if (knownStatusFilter === 'unknown') {
                tempFiltered = tempFiltered.filter(card => !card.isKnown);
            }
            filteredFlashcards = tempFiltered;
            currentFlashcardIndex = 0;
            displayFlashcard();
        }

        function loadFlashcards() {
            if (shuffleActive) {
                flashcards = [...originalFlashcards];
                shuffleArray(flashcards);
            } else {
                flashcards = [...originalFlashcards];
            }
            applyAllFlashcardFilters();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        let quizQuestions = [];
        let currentQuizQuestionIndex = 0;
        let quizScore = 0;
        let quizActive = false;
        let quizInitialized = false;
        let selectedMatchItems = { a: null, b: null };


        function prepareQuizData() {
            if(quizInitialized) return;
            quizInitialized = true;
        }

        function generateQuizQuestions(numQuestions, questionType) {
            let availableQuestions = [];
            const allSceneKeys = Object.keys(sceneData);

            if (questionType === 'all' || questionType === 'mcq_roles') {
                allSceneKeys.forEach(key => {
                    ['adamRole', 'evaRole', 'luciferRole'].forEach(roleType => {
                        if (sceneData[key][roleType] && sceneData[key][roleType] !== "N/A") {
                            const correctAnswer = sceneData[key][roleType];
                            const distractors = [];
                            while (distractors.length < 3) {
                                const randomKey = allSceneKeys[Math.floor(Math.random() * allSceneKeys.length)];
                                const randomRole = sceneData[randomKey][roleType];
                                if (randomRole && randomRole !== "N/A" && randomRole !== correctAnswer && !distractors.includes(randomRole)) {
                                    distractors.push(randomRole);
                                }
                            }
                            let charName = "";
                            if(roleType === 'adamRole') charName = "Ádám";
                            else if(roleType === 'evaRole') charName = "Éva";
                            else if(roleType === 'luciferRole') charName = "Lucifer";

                            availableQuestions.push({
                                type: 'mcq',
                                question: `Ki/Mi volt ${charName} szerepe a(z) "${sceneData[key].title}" színben?`,
                                options: shuffleArray([correctAnswer, ...distractors]),
                                correctAnswer: correctAnswer
                            });
                        }
                    });
                });
            }

            if (questionType === 'all' || questionType === 'mcq_ideas') {
                allSceneKeys.forEach(key => {
                    if (sceneData[key].mainIdea && sceneData[key].mainIdea !== "N/A") {
                        const correctAnswer = sceneData[key].mainIdea;
                        const distractors = [];
                        while (distractors.length < 3) {
                            const randomKey = allSceneKeys[Math.floor(Math.random() * allSceneKeys.length)];
                            if (randomKey !== key && sceneData[randomKey].mainIdea && sceneData[randomKey].mainIdea !== "N/A" && !distractors.includes(sceneData[randomKey].mainIdea)) {
                                distractors.push(sceneData[randomKey].mainIdea);
                            }
                            if (distractors.length < 3 && !distractors.includes("A semmiről nem szólt.")) distractors.push("A semmiről nem szólt.");
                        }
                        availableQuestions.push({
                            type: 'mcq',
                            question: `Mi volt a központi eszme/téma a(z) "${sceneData[key].title}" színben?`,
                            options: shuffleArray([correctAnswer, ...distractors]),
                            correctAnswer: correctAnswer
                        });
                    }
                });
            }
            if (questionType === 'all' || questionType === 'match_scene_role') {
                const itemsToMatch = 4;
                let availablePairs = allSceneKeys.map(key => ({ scene: sceneData[key].title, role: sceneData[key].adamRole }))
                                            .filter(p => p.role && p.role !== "N/A");
                if (availablePairs.length >= itemsToMatch) {
                    shuffleArray(availablePairs);
                    const selectedPairs = availablePairs.slice(0, itemsToMatch);
                    availableQuestions.push({
                        type: 'match',
                        question: "Párosítsd a színeket Ádám ottani szerepével:",
                        columnA_header: "Szín",
                        columnB_header: "Ádám Szerepe",
                        pairs: selectedPairs.map(p => ({ itemA: p.scene, itemB: p.role }))
                    });
                }
            }
            if (questionType === 'all' || questionType === 'match_scene_idea') {
                const itemsToMatch = 4;
                let availablePairs = allSceneKeys.map(key => ({ scene: sceneData[key].title, idea: sceneData[key].mainIdea }))
                                            .filter(p => p.idea && p.idea !== "N/A");
                if (availablePairs.length >= itemsToMatch) {
                    shuffleArray(availablePairs);
                    const selectedPairs = availablePairs.slice(0, itemsToMatch);
                    availableQuestions.push({
                        type: 'match',
                        question: "Párosítsd a színeket a központi eszméjükkel:",
                        columnA_header: "Szín",
                        columnB_header: "Központi Eszme",
                        pairs: selectedPairs.map(p => ({ itemA: p.scene, itemB: p.idea }))
                    });
                }
            }


            shuffleArray(availableQuestions);
            quizQuestions = numQuestions === 'all' ? availableQuestions : availableQuestions.slice(0, parseInt(numQuestions));
        }


        function startQuiz() {
            const numQuestions = document.getElementById('quizNumQuestions').value;
            const questionType = document.getElementById('quizQuestionType').value;

            if (!quizInitialized) prepareQuizData();
            generateQuizQuestions(numQuestions, questionType);

            if (quizQuestions.length === 0) {
                alert("Nem sikerült elegendő kérdést generálni a kiválasztott típushoz. Próbálj más beállításokat!");
                return;
            }

            currentQuizQuestionIndex = 0;
            quizScore = 0;
            quizActive = true;
            document.getElementById('quizSetupArea').style.display = 'none';
            document.getElementById('quizResultsArea').style.display = 'none';
            document.getElementById('quizQuestionArea').style.display = 'block';
            displayQuizQuestion();
            updateQuizProgress();
        }

        function displayQuizQuestion() {
            if (currentQuizQuestionIndex >= quizQuestions.length) {
                showQuizResults();
                return;
            }
            const q = quizQuestions[currentQuizQuestionIndex];
            document.getElementById('questionText').innerHTML = q.question;
            document.getElementById('feedbackText').textContent = '';
            document.getElementById('nextQuestionButton').style.display = 'none';
            document.getElementById('checkAnswerButton').style.display = q.type === 'mcq' ? 'inline-block' : 'none';
            document.getElementById('matchSubmitButton').style.display = q.type === 'match' ? 'inline-block' : 'none';


            const mcqOptionsDiv = document.getElementById('mcqOptions');
            const matchingOptionsDiv = document.getElementById('matchingOptions');
            mcqOptionsDiv.innerHTML = '';
            matchingOptionsDiv.style.display = 'none';
            document.getElementById('matchingColumnA').innerHTML = '';
            document.getElementById('matchingColumnB').innerHTML = '';


            if (q.type === 'mcq') {
                mcqOptionsDiv.style.display = 'grid';
                q.options.forEach(option => {
                    const button = document.createElement('button');
                    button.innerHTML = option;
                    button.onclick = () => selectMCQOption(button, option);
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('quiz-option');
                    wrapper.appendChild(button);
                    mcqOptionsDiv.appendChild(wrapper);
                });
            } else if (q.type === 'match') {
                matchingOptionsDiv.style.display = 'block';
                const colA = document.getElementById('matchingColumnA');
                const colB = document.getElementById('matchingColumnB');
                colA.innerHTML = `<h5>${q.columnA_header || 'A oszlop'}</h5>`;
                colB.innerHTML = `<h5>${q.columnB_header || 'B oszlop'}</h5>`;

                const shuffledB = shuffleArray([...q.pairs.map(p => p.itemB)]);

                q.pairs.forEach((pair, index) => {
                    const liA = document.createElement('li');
                    liA.innerHTML = pair.itemA;
                    liA.dataset.matchId = pair.itemA;
                    liA.dataset.pairIndex = index;
                    liA.onclick = () => selectMatchItem(liA, 'a');
                    colA.appendChild(liA);

                    const liB = document.createElement('li');
                    liB.innerHTML = shuffledB[index];
                    liB.dataset.matchId = shuffledB[index];
                    liB.onclick = () => selectMatchItem(liB, 'b');
                    colB.appendChild(liB);
                });
                selectedMatchItems = { a: null, b: null };
            }
            updateQuizProgress();
        }

        let selectedMCQButton = null;
        function selectMCQOption(button, option) {
            if (!quizActive) return;
            if (selectedMCQButton) {
                selectedMCQButton.classList.remove('selected');
            }
            button.classList.add('selected');
            selectedMCQButton = button;
        }


        function checkAnswer() {
            if (!selectedMCQButton || !quizActive) {
                document.getElementById('feedbackText').textContent = "Kérlek, válassz egy opciót!";
                return;
            }
            quizActive = false;
            const q = quizQuestions[currentQuizQuestionIndex];
            const selectedAnswer = selectedMCQButton.innerHTML;

            document.querySelectorAll('#mcqOptions .quiz-option button').forEach(btn => {
                btn.disabled = true;
                if (btn.innerHTML === q.correctAnswer) {
                    btn.classList.add('correct');
                }
            });

            if (selectedAnswer === q.correctAnswer) {
                document.getElementById('feedbackText').textContent = "Helyes válasz!";
                document.getElementById('feedbackText').style.color = 'var(--quiz-correct-text)';
                selectedMCQButton.classList.add('correct');
                quizScore++;
            } else {
                document.getElementById('feedbackText').textContent = `Helytelen. A jó válasz: ${q.correctAnswer}`;
                document.getElementById('feedbackText').style.color = 'var(--quiz-incorrect-text)';
                selectedMCQButton.classList.add('incorrect');
            }
            document.getElementById('nextQuestionButton').style.display = 'inline-block';
            document.getElementById('checkAnswerButton').style.display = 'none';
            updateQuizScore();
        }

        function selectMatchItem(liElement, column) {
            if (!quizActive) return;
            const previouslySelected = document.querySelector(`.matching-column li.selected-match-item-${column}`);
            if (previouslySelected) {
                previouslySelected.classList.remove(`selected-match-item-${column}`);
            }
            liElement.classList.add(`selected-match-item-${column}`);
            selectedMatchItems[column] = liElement;
        }

        function submitMatchAnswer() {
            if (!selectedMatchItems.a || !selectedMatchItems.b || !quizActive) {
                document.getElementById('feedbackText').textContent = "Kérlek, válassz egy-egy elemet mindkét oszlopból!";
                return;
            }
            quizActive = false;
            const q = quizQuestions[currentQuizQuestionIndex];
            const itemA_value = selectedMatchItems.a.dataset.matchId;
            const itemB_value = selectedMatchItems.b.dataset.matchId;

            const correctPair = q.pairs.find(p => p.itemA === itemA_value);

            if (correctPair && correctPair.itemB === itemB_value) {
                document.getElementById('feedbackText').textContent = "Helyes párosítás!";
                document.getElementById('feedbackText').style.color = 'var(--quiz-correct-text)';
                selectedMatchItems.a.classList.add('correct-match');
                selectedMatchItems.b.classList.add('correct-match');
                quizScore++;
            } else {
                document.getElementById('feedbackText').textContent = `Helytelen. "${itemA_value}" helyes párja: "${correctPair ? correctPair.itemB : 'N/A'}" lett volna.`;
                document.getElementById('feedbackText').style.color = 'var(--quiz-incorrect-text)';
                selectedMatchItems.a.classList.add('incorrect-match');
                selectedMatchItems.b.classList.add('incorrect-match');
            }

            document.querySelectorAll('.matching-column li').forEach(li => li.onclick = null);
            document.getElementById('nextQuestionButton').style.display = 'inline-block';
            document.getElementById('matchSubmitButton').style.display = 'none';
            updateQuizScore();
        }


        function nextQuizQuestion() {
            currentQuizQuestionIndex++;
            quizActive = true;
            selectedMCQButton = null;
            if (currentQuizQuestionIndex < quizQuestions.length) {
                displayQuizQuestion();
            } else {
                showQuizResults();
            }
        }

        function showQuizResults() {
            document.getElementById('quizQuestionArea').style.display = 'none';
            document.getElementById('quizResultsArea').style.display = 'block';
            const percentage = quizQuestions.length > 0 ? Math.round((quizScore / quizQuestions.length) * 100) : 0;
            document.getElementById('finalScoreText').textContent = `Pontszámod: ${quizScore} / ${quizQuestions.length}`;
            document.getElementById('finalPercentageText').textContent = `Százalék: ${percentage}%`;
        }

        function restartQuizSetup() {
            document.getElementById('quizResultsArea').style.display = 'none';
            document.getElementById('quizSetupArea').style.display = 'block';
            document.getElementById('quizProgress').textContent = '';
            document.getElementById('quizScore').textContent = '';
        }

        function updateQuizProgress() {
            document.getElementById('quizProgress').textContent = `Kérdés: ${currentQuizQuestionIndex + 1} / ${quizQuestions.length}`;
        }
        function updateQuizScore(){
            document.getElementById('quizScore').textContent = `Pontszám: ${quizScore}`;
        }

        function speakSceneContent() {
            const contentDiv = document.getElementById('sceneContentDetail');
            if (!contentDiv) return;
            let textToSpeak = (document.getElementById('sceneTitleDetail')?.innerText || "") + ". ";
            contentDiv.querySelectorAll('h5, p, li, .quote, summary').forEach(el => {
                if (el.offsetParent !== null) {
                    let text = el.innerText || el.textContent;
                    text = text.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, ' ').trim();
                    if (el.tagName === 'H5' || el.tagName === 'SUMMARY') text = el.innerText + ": ";
                    textToSpeak += text + ". ";
                }
            });
            console.log("Elküldendő szöveg a backendnek (első 500 karakter):", textToSpeak.substring(0, 500) + "...");
            alert("Ez a funkció egy backend szervert igényel a Google Cloud TTS API hívásához. A szöveg (első 500 karakter) a konzolon látható.");
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyInitialDarkMode();
            getSceneDataFromDOM();
            populateTimeline();
            prepareFlashcards();
            prepareQuizData();
            showView('mapView');
        });
    </script>
</body>
</html>